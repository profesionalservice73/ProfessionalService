import React, { useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  SafeAreaView,
  TouchableOpacity,
  KeyboardAvoidingView,
  Platform,
  ScrollView,
  Image,
  Alert,
  TextInput,
  ActivityIndicator,
} from "react-native";
import { Ionicons } from "@expo/vector-icons";
import { LinearGradient } from "expo-linear-gradient";
import * as ImagePicker from "expo-image-picker";
import * as DocumentPicker from "expo-document-picker";

import { Input } from "../components/Input";
import { Button } from "../components/Button";
import { theme } from "../config/theme";
import { useAuth } from "../contexts/AuthContext";
import { Header } from "../components/Header";
import { EnhancedServiceIcon } from "../components/EnhancedServiceIcon";
import { useProfessional } from "../contexts/ProfessionalContext";
import { professionalAPI, authAPI } from "../services/api";
import { CountryPhoneInput } from "../components/CountryPhoneInput";

// Datos para el formulario de profesionales
const categories = [
  { id: "plomeria", name: "Plomer√≠a", icon: "water", color: "#3b82f6" },
  { id: "gas", name: "Gas", icon: "flame", color: "#f97316" },
  { id: "electricidad", name: "Electricidad", icon: "flash", color: "#f59e0b" },
  {
    id: "albanileria",
    name: "Alba√±iler√≠a",
    icon: "construct",
    color: "#ef4444",
  },
  { id: "carpinteria", name: "Carpinter√≠a", icon: "hammer", color: "#8b4513" },
  { id: "herreria", name: "Herrer√≠a", icon: "hardware-chip", color: "#64748b" },
  { id: "limpieza", name: "Limpieza", icon: "sparkles", color: "#8b5cf6" },
  { id: "mecanica", name: "Mec√°nica", icon: "car", color: "#1e293b" },
  {
    id: "aire_acondicionado",
    name: "Aire Acondicionado",
    icon: "thermometer",
    color: "#0ea5e9",
  },
  {
    id: "tecnico_comp_redes",
    name: "T√©cnico en Comp y Redes",
    icon: "laptop",
    color: "#6366f1",
  },
  { id: "cerrajeria", name: "Cerrajer√≠a", icon: "key", color: "#7c3aed" },
];

const experienceLevels = [
  { id: "beginner", name: "Principiante (0-2 a√±os)" },
  { id: "intermediate", name: "Intermedio (2-5 a√±os)" },
  { id: "advanced", name: "Avanzado (5+ a√±os)" },
];

export default function RegisterScreen({ navigation }: any) {
  const { register, loading } = useAuth();
  const { setRegistrationComplete, loadProfessionalData } = useProfessional();

  // Estado para controlar si se ha seleccionado el rol
  const [roleSelected, setRoleSelected] = useState(false);
  const [selectedRole, setSelectedRole] = useState<
    "client" | "professional" | null
  >(null);


  // Estados para el formulario de cliente
  const [clientFormData, setClientFormData] = useState({
    fullName: "",
    email: "",
    phone: "",
    password: "",
    confirmPassword: "",
  });
  const [clientSelectedCountry, setClientSelectedCountry] = useState({
    code: "AR",
    name: "Argentina",
    dialCode: "+54",
    flag: "üá¶üá∑",
  });

  // Estados para el formulario de profesional
  const [professionalFormData, setProfessionalFormData] = useState({
    fullName: "",
    email: "",
    phone: "",
    password: "",
    confirmPassword: "",
    specialties: [] as string[],
    experience: "",
    description: "",
    location: "",
    availability: "",
    responseTime: "",
    services: [] as string[],
    priceRange: "",
    certifications: [] as string[],
    certificationDocuments: [] as (string | null)[],
    languages: [] as string[],
    // Documentos de verificaci√≥n
    dni: "",
    dniImage: null as string | null,
    professionalLicense: null as string | null,
    insuranceCertificate: null as string | null,
    // Informaci√≥n adicional
    businessName: "",
    taxId: "",
    emergencyContact: "",
    emergencyPhone: "",
    // Foto de perfil
    profilePhoto: null as string | null,
  });
  const [professionalSelectedCountry, setProfessionalSelectedCountry] = useState({
    code: "AR",
    name: "Argentina",
    dialCode: "+54",
    flag: "üá¶üá∑",
  });

  // Estados para im√°genes de profesional
  const [profileImage, setProfileImage] = useState<string | null>(null);
  const [dniFrontImage, setDniFrontImage] = useState<string | null>(null);
  const [dniBackImage, setDniBackImage] = useState<string | null>(null);

  // Estados para campos din√°micos de profesional
  const [serviceText, setServiceText] = useState("");
  const [certificationText, setCertificationText] = useState("");
  const [languageText, setLanguageText] = useState("");

  // Estados para el formulario de profesional por pasos
  const [currentStep, setCurrentStep] = useState(1);
  const [professionalLoading, setProfessionalLoading] = useState(false);

  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  const updateClientFormData = (field: string, value: string) => {
    setClientFormData((prev) => ({ ...prev, [field]: value }));
    if (errors[field]) {
      setErrors((prev) => ({ ...prev, [field]: "" }));
    }
  };

  const updateProfessionalFormData = (field: string, value: any) => {
    setProfessionalFormData((prev) => ({ ...prev, [field]: value }));
    if (errors[field]) {
      setErrors((prev) => ({ ...prev, [field]: "" }));
    }
  };

  // Funciones para campos din√°micos de profesionales
  const handleAddService = () => {
    if (serviceText.trim()) {
      setProfessionalFormData((prev) => ({
        ...prev,
        services: [...prev.services, serviceText.trim()],
      }));
      setServiceText("");
    }
  };

  const handleAddCertification = () => {
    if (certificationText.trim()) {
      setProfessionalFormData((prev) => ({
        ...prev,
        certifications: [...prev.certifications, certificationText.trim()],
        certificationDocuments: [...prev.certificationDocuments, null],
      }));
      setCertificationText("");
    }
  };

  const handleAddLanguage = () => {
    if (languageText.trim()) {
      setProfessionalFormData((prev) => ({
        ...prev,
        languages: [...prev.languages, languageText.trim()],
      }));
      setLanguageText("");
    }
  };

  // Funciones para manejar especialidades m√∫ltiples
  const handleToggleSpecialty = (specialtyId: string) => {
    setProfessionalFormData((prev) => ({
      ...prev,
      specialties: prev.specialties.includes(specialtyId)
        ? prev.specialties.filter((id) => id !== specialtyId)
        : [...prev.specialties, specialtyId],
    }));
  };

  const handleRemoveSpecialty = (specialtyId: string) => {
    setProfessionalFormData((prev) => ({
      ...prev,
      specialties: prev.specialties.filter((id) => id !== specialtyId),
    }));
  };

  // Funciones para manejo de im√°genes y documentos
  const takeDocumentPhoto = async (
    field: "dniImage" | "professionalLicense" | "insuranceCertificate"
  ) => {
    const { status } = await ImagePicker.requestCameraPermissionsAsync();
    if (status !== "granted") {
      Alert.alert(
        "Permisos",
        "Se necesitan permisos de c√°mara para tomar la foto"
      );
      return;
    }

    const result = await ImagePicker.launchCameraAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [4, 3],
      quality: 0.8,
    });

    if (!result.canceled && result.assets[0]) {
      setProfessionalFormData((prev) => ({
        ...prev,
        [field]: result.assets[0].uri,
      }));
    }
  };

  const selectDocumentImage = async (
    field: "dniImage" | "professionalLicense" | "insuranceCertificate"
  ) => {
    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (status !== "granted") {
      Alert.alert(
        "Permisos",
        "Se necesitan permisos de galer√≠a para seleccionar la imagen"
      );
      return;
    }

    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [4, 3],
      quality: 0.8,
    });

    if (!result.canceled && result.assets[0]) {
      setProfessionalFormData((prev) => ({
        ...prev,
        [field]: result.assets[0].uri,
      }));
    }
  };

  // Funciones para verificaci√≥n inicial



  const handleRemoveService = (index: number) => {
    setProfessionalFormData((prev) => ({
      ...prev,
      services: prev.services.filter((_, i) => i !== index),
    }));
  };

  const handleRemoveCertification = (index: number) => {
    setProfessionalFormData((prev) => ({
      ...prev,
      certifications: prev.certifications.filter((_, i) => i !== index),
      certificationDocuments: prev.certificationDocuments.filter(
        (_, i) => i !== index
      ),
    }));
  };

  const handleRemoveLanguage = (index: number) => {
    setProfessionalFormData((prev) => ({
      ...prev,
      languages: prev.languages.filter((_, i) => i !== index),
    }));
  };

  // Funciones para manejar documentos de certificaci√≥n
  const handleRemoveCertificationDocument = (index: number) => {
    setProfessionalFormData((prev) => ({
      ...prev,
      certificationDocuments: prev.certificationDocuments.map((doc, i) =>
        i === index ? null : doc
      ),
    }));
  };

  const takeCertificationDocument = async (index: number) => {
    try {
      const result = await ImagePicker.launchCameraAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        aspect: [4, 3],
        quality: 0.8,
      });

      if (!result.canceled && result.assets[0]) {
        setProfessionalFormData((prev) => ({
          ...prev,
          certificationDocuments: prev.certificationDocuments.map((doc, i) =>
            i === index ? result.assets[0].uri : doc
          ),
        }));
      }
    } catch (error) {
      console.error("Error al tomar foto:", error);
    }
  };

  const selectCertificationDocument = async (index: number) => {
    try {
      const result = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        aspect: [4, 3],
        quality: 0.8,
      });

      if (!result.canceled && result.assets[0]) {
        setProfessionalFormData((prev) => ({
          ...prev,
          certificationDocuments: prev.certificationDocuments.map((doc, i) =>
            i === index ? result.assets[0].uri : doc
          ),
        }));
      }
    } catch (error) {
      console.error("Error al seleccionar imagen:", error);
    }
  };

  const selectCertificationPDF = async (index: number) => {
    try {
      const result = await DocumentPicker.getDocumentAsync({
        type: [
          "application/pdf",
          "application/msword",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          "text/plain",
          "application/vnd.ms-excel",
          "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        ],
        copyToCacheDirectory: true,
      });

      if (!result.canceled && result.assets[0]) {
        setProfessionalFormData((prev) => ({
          ...prev,
          certificationDocuments: prev.certificationDocuments.map((doc, i) =>
            i === index ? result.assets[0].uri : doc
          ),
        }));
      }
    } catch (error) {
      console.error("Error al seleccionar PDF/documento:", error);
    }
  };

  // Funciones para manejar im√°genes
  const requestPermissions = async () => {
    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (status !== "granted") {
      Alert.alert(
        "Permisos Requeridos",
        "Necesitamos acceso a tu galer√≠a para seleccionar fotos.",
        [{ text: "OK" }]
      );
      return false;
    }
    return true;
  };



  const validateEmail = (email: string) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };

  const validatePhone = (phone: string, countryCode: string) => {
    // Remover espacios y caracteres especiales
    const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    
    // Validar que sea solo n√∫meros y tenga al menos 7 d√≠gitos
    const phoneRegex = /^\d{7,15}$/;
    return phoneRegex.test(cleanPhone);
  };

  const validateClientForm = () => {
    const newErrors: Record<string, string> = {};

    if (!clientFormData.fullName.trim()) {
      newErrors.fullName = "El nombre completo es requerido";
    }

    if (!clientFormData.email) {
      newErrors.email = "El email es requerido";
    } else if (!validateEmail(clientFormData.email)) {
      newErrors.email = "Email inv√°lido";
    }

    if (!clientFormData.phone) {
      newErrors.phone = "El tel√©fono es requerido";
    } else if (!validatePhone(clientFormData.phone, clientSelectedCountry.code)) {
      newErrors.phone = "Tel√©fono inv√°lido";
    }

    if (!clientFormData.password) {
      newErrors.password = "La contrase√±a es requerida";
    } else if (clientFormData.password.length < 6) {
      newErrors.password = "La contrase√±a debe tener al menos 6 caracteres";
    }

    if (!clientFormData.confirmPassword) {
      newErrors.confirmPassword = "Confirma tu contrase√±a";
    } else if (clientFormData.password !== clientFormData.confirmPassword) {
      newErrors.confirmPassword = "Las contrase√±as no coinciden";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const validateProfessionalStep = (step: number) => {
    const newErrors: Record<string, string> = {};

    if (step === 1) {
      if (!professionalFormData.fullName.trim())
        newErrors.fullName = "El nombre completo es requerido";
      if (!professionalFormData.phone.trim())
        newErrors.phone = "El tel√©fono es requerido";
      else if (!validatePhone(professionalFormData.phone, professionalSelectedCountry.code))
        newErrors.phone = "Tel√©fono inv√°lido";
      if (!professionalFormData.email.trim())
        newErrors.email = "El email es requerido";
      else if (!validateEmail(professionalFormData.email))
        newErrors.email = "Email inv√°lido";
      if (!professionalFormData.password)
        newErrors.password = "La contrase√±a es requerida";
      else if (professionalFormData.password.length < 6)
        newErrors.password = "La contrase√±a debe tener al menos 6 caracteres";
      if (!professionalFormData.confirmPassword)
        newErrors.confirmPassword = "Confirma tu contrase√±a";
      if (
        professionalFormData.password !== professionalFormData.confirmPassword
      ) {
        newErrors.confirmPassword = "Las contrase√±as no coinciden";
      }
      // El KYC se validar√° despu√©s de completar los datos b√°sicos
    }

    if (step === 2) {
      if (professionalFormData.specialties.length === 0)
        newErrors.specialties = "Selecciona al menos una especialidad";
      if (!professionalFormData.experience)
        newErrors.experience = "Selecciona tu nivel de experiencia";
      if (!professionalFormData.description.trim())
        newErrors.description = "La descripci√≥n es requerida";
      if (!professionalFormData.location.trim())
        newErrors.location = "La ubicaci√≥n es requerida";
    }

    if (step === 3) {
      if (professionalFormData.services.length === 0)
        newErrors.services = "Agrega al menos un servicio";
      if (!professionalFormData.priceRange.trim())
        newErrors.priceRange = "El rango de precios es requerido";
    }

    if (step === 4) {
      if (professionalFormData.certifications.length === 0)
        newErrors.certifications = "Agrega al menos una certificaci√≥n";
      if (professionalFormData.languages.length === 0)
        newErrors.languages = "Agrega al menos un idioma";

      // Validar que cada certificaci√≥n tenga su documento
      const missingDocuments = professionalFormData.certifications.filter(
        (_, index) => !professionalFormData.certificationDocuments[index]
      );
      if (missingDocuments.length > 0) {
        newErrors.certifications =
          "Cada certificaci√≥n debe tener su documento correspondiente";
      }
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleClientRegister = async () => {
    if (validateClientForm()) {
      try {
        const result = await register({
          ...clientFormData,
          phone: `${clientSelectedCountry.dialCode}${clientFormData.phone}`,
          userType: "client",
        });

        if (result.success) {
          Alert.alert("√âxito", result.message, [
            {
              text: "OK",
              onPress: () => navigation.navigate("Login"),
            },
          ]);
        } else {
          Alert.alert("Error", result.message);
        }
      } catch (error) {
        Alert.alert("Error", "Error al conectar con el servidor");
      }
    }
  };

  const handleProfessionalNext = () => {
    console.log('üîÑ handleProfessionalNext llamado');
    console.log('üìä Estado actual:', {
      currentStep,
      professionalLoading
    });
    
    const isValid = validateProfessionalStep(currentStep);
    console.log('‚úÖ Validaci√≥n del paso:', isValid);
    
    if (isValid) {
      if (currentStep < 4) {
        console.log(`‚û°Ô∏è Avanzando al paso ${currentStep + 1}...`);
        setCurrentStep(currentStep + 1);
      } else {
        // En el paso 4 (√∫ltimo), completar el registro
        console.log('üöÄ Paso 4: Iniciando handleProfessionalSubmit...');
        handleProfessionalSubmit();
      }
    } else {
      console.log('‚ùå Validaci√≥n fall√≥, no se puede continuar');
    }
  };

  const handleProfessionalBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleProfessionalSubmit = async () => {
    console.log('üéØ handleProfessionalSubmit iniciado');
    console.log('üìä Estado en handleProfessionalSubmit:', {
      currentStep,
      professionalLoading
    });
    
    const isValid = validateProfessionalStep(currentStep);
    console.log('‚úÖ Validaci√≥n en handleProfessionalSubmit:', isValid);
    
    if (isValid) {
      console.log('üîÑ Iniciando proceso de registro...');
      setProfessionalLoading(true);
      try {
        // Log para debugging
        console.log("Enviando datos del profesional:", {
          formData: professionalFormData,
        });

        // Log detallado de cada campo
        console.log("Validaci√≥n de campos antes del env√≠o:", {
          fullName: !!professionalFormData.fullName,
          email: !!professionalFormData.email,
          phone: !!professionalFormData.phone,
          specialties: !!professionalFormData.specialties,
          specialtiesLength: professionalFormData.specialties.length,
          experience: !!professionalFormData.experience,
          description: !!professionalFormData.description,
          location: !!professionalFormData.location,
          profilePhoto: !!professionalFormData.profilePhoto,
        });

        // Paso 1: Registrar usuario b√°sico
        console.log('üîµ Paso 1: Registrando usuario b√°sico...');
        console.log('üìã Datos del usuario:', {
          fullName: professionalFormData.fullName,
          email: professionalFormData.email,
          phone: `${professionalSelectedCountry.dialCode}${professionalFormData.phone}`,
          userType: "professional"
        });

        const userRegisterResult = await register({
          fullName: professionalFormData.fullName,
          email: professionalFormData.email,
          phone: `${professionalSelectedCountry.dialCode}${professionalFormData.phone}`,
          password: professionalFormData.password,
          confirmPassword: professionalFormData.confirmPassword,
          userType: "professional",
        });

        console.log('üìä Resultado del registro de usuario:', userRegisterResult);
        console.log('üîç Estructura de datos recibida:', {
          success: userRegisterResult.success,
          data: userRegisterResult.data,
          dataId: userRegisterResult.data?.id,
          message: userRegisterResult.message
        });

        if (!userRegisterResult.success) {
          console.error('‚ùå Error en registro de usuario:', userRegisterResult);
          throw new Error(userRegisterResult.message || 'Error registrando usuario');
        }

        if (!userRegisterResult.data || !userRegisterResult.data.id) {
          console.error('‚ùå Error: No se recibi√≥ el ID del usuario:', userRegisterResult);
          throw new Error('No se recibi√≥ el ID del usuario registrado');
        }

        console.log('‚úÖ Usuario registrado exitosamente, creando perfil profesional...');

        // Paso 2: Crear perfil profesional
        console.log('üü¢ Paso 2: Creando perfil profesional...');
        const professionalData = {
          userId: userRegisterResult.data.id,
          specialties: professionalFormData.specialties,
          experience: professionalFormData.experience,
          description: professionalFormData.description,
          location: professionalFormData.location,
          availability: professionalFormData.availability,
          responseTime: professionalFormData.responseTime,
          profileImage: professionalFormData.profilePhoto,
          services: professionalFormData.services,
          priceRange: professionalFormData.priceRange,
          certifications: professionalFormData.certifications,
          certificationDocuments: professionalFormData.certificationDocuments,
          languages: professionalFormData.languages,
        };

        console.log('üìã Datos del perfil profesional:', professionalData);
        console.log('üöÄ Enviando datos del perfil profesional al backend...');
        
        const professionalRegisterResult = await professionalAPI.register(professionalData);
        
        console.log('üìä Resultado del registro profesional:', professionalRegisterResult);

        if (!professionalRegisterResult.success) {
          console.error('‚ùå Error en registro profesional:', professionalRegisterResult);
          throw new Error(professionalRegisterResult.error || 'Error creando perfil profesional');
        }

        console.log('‚úÖ Perfil profesional creado exitosamente');
        const registerResult = { success: true, message: 'Registro completo exitoso' };

        if (registerResult.success) {
          Alert.alert(
            "Registro Exitoso",
            "Tu perfil profesional ha sido creado exitosamente. Por favor, inicia sesi√≥n para continuar.",
            [
              {
                text: "OK",
                onPress: () => navigation.navigate("Login"),
              },
            ]
          );
        } else {
          Alert.alert("Error", registerResult.message);
        }
      } catch (error) {
        console.error('üí• Error completo en el registro:', error);
        console.error('üí• Error message:', error.message);
        console.error('üí• Error stack:', error.stack);
        Alert.alert("Error", `Error de conexi√≥n al completar el registro: ${error.message}`);
      } finally {
        setProfessionalLoading(false);
      }
    } else {
      console.log('‚ùå Validaci√≥n fall√≥ en handleProfessionalSubmit, no se puede continuar');
      console.log('üìã Datos actuales del formulario:', {
        fullName: professionalFormData.fullName,
        email: professionalFormData.email,
        phone: professionalFormData.phone,
        specialties: professionalFormData.specialties,
        experience: professionalFormData.experience,
        description: professionalFormData.description,
        location: professionalFormData.location
      });
    }
  };

  const handleRoleSelection = (role: "client" | "professional") => {
    setSelectedRole(role);
    setRoleSelected(true);
    setCurrentStep(1);
    setErrors({});
  };


  const handleBackToRoleSelection = () => {
    setRoleSelected(false);
    setSelectedRole(null);
    setCurrentStep(1);
    setErrors({});
    // Limpiar formularios
    setClientFormData({
      fullName: "",
      email: "",
      phone: "",
      password: "",
      confirmPassword: "",
    });
    setProfessionalFormData({
      fullName: "",
      email: "",
      phone: "",
      password: "",
      confirmPassword: "",
      specialties: [],
      experience: "",
      description: "",
      location: "",
      availability: "",
      responseTime: "",
      services: [],
      priceRange: "",
      certifications: [],
      certificationDocuments: [],
      languages: [],
      dni: "",
      dniImage: null,
      professionalLicense: null,
      insuranceCertificate: null,
      businessName: "",
      taxId: "",
      emergencyContact: "",
      emergencyPhone: "",
      profilePhoto: null,
    });
    setProfileImage(null);
    setDniFrontImage(null);
    setDniBackImage(null);
  };

  // Renderizar selecci√≥n de rol
  const renderRoleSelection = () => (
    <View style={styles.container}>
      <KeyboardAvoidingView
        behavior={Platform.OS === "ios" ? "padding" : "height"}
        style={styles.keyboardView}
      >
        <ScrollView
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
        >
          {/* Header con gradiente */}
          <LinearGradient
            colors={[theme.colors.primary, theme.colors.secondary]}
            style={styles.header}
          >
            <View style={styles.logoContainer}>
              <View style={styles.logoCircle}>
                <Image
                  source={require("../assets/icon.png")}
                  style={styles.logoImage}
                  resizeMode="contain"
                />
              </View>
            </View>
            <Text style={styles.title}>¬°Registrate!</Text>
            <Text style={styles.subtitle}>
              Crea tu cuenta en Professional Service
            </Text>
          </LinearGradient>

          {/* Selecci√≥n de rol */}
          <View style={styles.formContainer}>
            <Text style={styles.roleSelectionTitle}>
              ¬øQu√© tipo de cuenta quieres crear?
            </Text>
            <Text style={styles.roleSelectionSubtitle}>
              Selecciona el rol que mejor te describa
            </Text>

            <View style={styles.roleButtonsContainer}>
              <TouchableOpacity
                style={styles.roleButton}
                onPress={() => handleRoleSelection("client")}
              >
                <View style={styles.roleIconContainer}>
                  <Ionicons
                    name="person"
                    size={40}
                    color={theme.colors.primary}
                  />
                </View>
                <Text style={styles.roleTitle}>Cliente</Text>
                <Text style={styles.roleDescription}>
                  Busco servicios profesionales para mis necesidades
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={styles.roleButton}
                onPress={() => handleRoleSelection("professional")}
              >
                <View style={styles.roleIconContainer}>
                  <Ionicons
                    name="briefcase"
                    size={40}
                    color={theme.colors.primary}
                  />
                </View>
                <Text style={styles.roleTitle}>Profesional</Text>
                <Text style={styles.roleDescription}>
                  Ofrezco servicios profesionales a clientes
                </Text>
              </TouchableOpacity>
            </View>

            {/* Login Link */}
            <View style={styles.loginContainer}>
              <Text style={styles.loginText}>¬øYa tienes cuenta? </Text>
              <TouchableOpacity onPress={() => navigation.navigate("Login")}>
                <Text style={styles.loginLink}>Inicia sesi√≥n aqu√≠</Text>
              </TouchableOpacity>
            </View>
          </View>
        </ScrollView>
      </KeyboardAvoidingView>
    </View>
  );

  // Renderizar formulario de cliente
  const renderClientForm = () => (
    <View style={styles.container}>
      <KeyboardAvoidingView
        behavior={Platform.OS === "ios" ? "padding" : "height"}
        style={styles.keyboardView}
      >
        <ScrollView
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
        >
          {/* Header con gradiente */}
          <LinearGradient
            colors={[theme.colors.primary, theme.colors.secondary]}
            style={styles.header}
          >
            <TouchableOpacity
              style={styles.backButton}
              onPress={handleBackToRoleSelection}
            >
              <Ionicons
                name="arrow-back"
                size={24}
                color={theme.colors.white}
              />
            </TouchableOpacity>
            <View style={styles.logoContainer}>
              <View style={styles.logoCircle}>
                <Image
                  source={require("../assets/icon.png")}
                  style={styles.logoImage}
                  resizeMode="contain"
                />
              </View>
            </View>
            <Text style={styles.title}>Registro de Cliente</Text>
            <Text style={styles.subtitle}>
              Crea tu cuenta para solicitar servicios
            </Text>
          </LinearGradient>

          {/* Form */}
          <View style={styles.formContainer}>
            <Input
              label="Nombre Completo"
              placeholder="Tu nombre completo"
              value={clientFormData.fullName}
              onChangeText={(value) => updateClientFormData("fullName", value)}
              error={errors.fullName}
            />

            <Input
              label="Email"
              placeholder="tu@email.com"
              value={clientFormData.email}
              onChangeText={(value) => updateClientFormData("email", value)}
              keyboardType="email-address"
              autoCapitalize="none"
              error={errors.email}
            />

            <CountryPhoneInput
              label="Tel√©fono"
              placeholder="Ingresa tu n√∫mero"
              value={clientFormData.phone}
              onChangeText={(value) => updateClientFormData("phone", value)}
              onCountryChange={setClientSelectedCountry}
              selectedCountry={clientSelectedCountry}
              error={errors.phone}
            />

            <View style={styles.passwordContainer}>
              <Input
                label="Contrase√±a"
                placeholder="Tu contrase√±a"
                value={clientFormData.password}
                onChangeText={(value) =>
                  updateClientFormData("password", value)
                }
                secureTextEntry={!showPassword}
                error={errors.password}
              />
              <TouchableOpacity
                style={styles.eyeButton}
                onPress={() => setShowPassword(!showPassword)}
              >
                <Ionicons
                  name={showPassword ? "eye-off" : "eye"}
                  size={20}
                  color={theme.colors.textSecondary}
                />
              </TouchableOpacity>
            </View>

            <View style={styles.passwordContainer}>
              <Input
                label="Confirmar Contrase√±a"
                placeholder="Confirma tu contrase√±a"
                value={clientFormData.confirmPassword}
                onChangeText={(value) =>
                  updateClientFormData("confirmPassword", value)
                }
                secureTextEntry={!showConfirmPassword}
                error={errors.confirmPassword}
              />
              <TouchableOpacity
                style={styles.eyeButton}
                onPress={() => setShowConfirmPassword(!showConfirmPassword)}
              >
                <Ionicons
                  name={showConfirmPassword ? "eye-off" : "eye"}
                  size={20}
                  color={theme.colors.textSecondary}
                />
              </TouchableOpacity>
            </View>

            <View style={styles.clientInfo}>
              <Text style={styles.infoText}>
                Como cliente podr√°s solicitar servicios de profesionales
                certificados y recibir cotizaciones personalizadas.
              </Text>
            </View>

            <Button
              title={loading ? "Creando..." : "Crear Cuenta de Cliente"}
              onPress={handleClientRegister}
              style={styles.registerButton}
              disabled={loading}
            />

            {/* Login Link */}
            <View style={styles.loginContainer}>
              <Text style={styles.loginText}>¬øYa tienes cuenta? </Text>
              <TouchableOpacity onPress={() => navigation.navigate("Login")}>
                <Text style={styles.loginLink}>Inicia sesi√≥n aqu√≠</Text>
              </TouchableOpacity>
            </View>
          </View>
        </ScrollView>
      </KeyboardAvoidingView>
    </View>
  );

  // Renderizar pasos del formulario de profesional
  const renderProfessionalStep1 = () => (
    <View style={styles.stepContainer}>
      <View style={styles.stepHeader}>
        <Ionicons name="person-circle" size={40} color={theme.colors.primary} />
        <Text style={styles.stepTitle}>Informaci√≥n Personal</Text>
        <Text style={styles.stepSubtitle}>
          Comencemos con tus datos b√°sicos
        </Text>
      </View>



      <Input
        label="Nombre Completo"
        placeholder="Tu nombre completo"
        value={professionalFormData.fullName}
        onChangeText={(value) => updateProfessionalFormData("fullName", value)}
        error={errors.fullName}
      />

      <Input
        label="Email"
        placeholder="tu@email.com"
        value={professionalFormData.email}
        onChangeText={(value) => updateProfessionalFormData("email", value)}
        keyboardType="email-address"
        autoCapitalize="none"
        error={errors.email}
      />

      <CountryPhoneInput
        label="Tel√©fono"
        placeholder="Ingresa tu n√∫mero"
        value={professionalFormData.phone}
        onChangeText={(value) => updateProfessionalFormData("phone", value)}
        onCountryChange={setProfessionalSelectedCountry}
        selectedCountry={professionalSelectedCountry}
        error={errors.phone}
      />

      <View style={styles.passwordContainer}>
        <Input
          label="Contrase√±a"
          placeholder="Tu contrase√±a"
          value={professionalFormData.password}
          onChangeText={(value) =>
            updateProfessionalFormData("password", value)
          }
          secureTextEntry={!showPassword}
          error={errors.password}
        />
        <TouchableOpacity
          style={styles.eyeButton}
          onPress={() => setShowPassword(!showPassword)}
        >
          <Ionicons
            name={showPassword ? "eye-off" : "eye"}
            size={20}
            color={theme.colors.textSecondary}
          />
        </TouchableOpacity>
      </View>

      <View style={styles.passwordContainer}>
        <Input
          label="Confirmar Contrase√±a"
          placeholder="Confirma tu contrase√±a"
          value={professionalFormData.confirmPassword}
          onChangeText={(value) =>
            updateProfessionalFormData("confirmPassword", value)
          }
          secureTextEntry={!showConfirmPassword}
          error={errors.confirmPassword}
        />
        <TouchableOpacity
          style={styles.eyeButton}
          onPress={() => setShowConfirmPassword(!showConfirmPassword)}
        >
          <Ionicons
            name={showConfirmPassword ? "eye-off" : "eye"}
            size={20}
            color={theme.colors.textSecondary}
          />
        </TouchableOpacity>
      </View>
    </View>
  );

  const renderProfessionalStep2 = () => (
    <View style={styles.stepContainer}>
      <View style={styles.stepHeader}>
        <Ionicons name="briefcase" size={40} color={theme.colors.primary} />
        <Text style={styles.stepTitle}>Informaci√≥n Profesional</Text>
        <Text style={styles.stepSubtitle}>Cu√©ntanos sobre tu experiencia</Text>
      </View>

      <View style={styles.inputContainer}>
        <Text style={styles.inputLabel}>Especialidades</Text>
        <Text style={styles.inputSubtext}>
          Selecciona todas las especialidades en las que trabajas
        </Text>
        <View style={styles.categoriesGrid}>
          {categories.map((category) => (
            <TouchableOpacity
              key={category.id}
              style={[
                styles.categoryCard,
                professionalFormData.specialties.includes(category.id) &&
                  styles.categoryCardActive,
              ]}
              onPress={() => handleToggleSpecialty(category.id)}
            >
              <EnhancedServiceIcon type={category.id} size={50} />
              <Text style={styles.categoryName}>{category.name}</Text>
              {professionalFormData.specialties.includes(category.id) && (
                <View style={styles.selectedIndicator}>
                  <Ionicons
                    name="checkmark-circle"
                    size={20}
                    color={theme.colors.white}
                  />
                </View>
              )}
            </TouchableOpacity>
          ))}
        </View>

        {/* Mostrar especialidades seleccionadas */}
        {professionalFormData.specialties.length > 0 && (
          <View style={styles.selectedSpecialtiesContainer}>
            <Text style={styles.selectedSpecialtiesTitle}>
              Especialidades seleccionadas:
            </Text>
            <View style={styles.selectedSpecialtiesList}>
              {professionalFormData.specialties.map((specialtyId) => {
                const category = categories.find(
                  (cat) => cat.id === specialtyId
                );
                return (
                  <View key={specialtyId} style={styles.selectedSpecialtyTag}>
                    <Text style={styles.selectedSpecialtyText}>
                      {category?.name}
                    </Text>
                    <TouchableOpacity
                      onPress={() => handleRemoveSpecialty(specialtyId)}
                    >
                      <Ionicons
                        name="close-circle"
                        size={16}
                        color={theme.colors.error}
                      />
                    </TouchableOpacity>
                  </View>
                );
              })}
            </View>
          </View>
        )}

        {errors.specialties && (
          <Text style={styles.errorText}>{errors.specialties}</Text>
        )}
      </View>

      <View style={styles.inputContainer}>
        <Text style={styles.inputLabel}>Nivel de Experiencia</Text>
        {experienceLevels.map((level) => (
          <TouchableOpacity
            key={level.id}
            style={[
              styles.experienceCard,
              professionalFormData.experience === level.id &&
                styles.experienceCardActive,
            ]}
            onPress={() => updateProfessionalFormData("experience", level.id)}
          >
            <Text
              style={[
                styles.experienceText,
                professionalFormData.experience === level.id &&
                  styles.experienceTextActive,
              ]}
            >
              {level.name}
            </Text>
          </TouchableOpacity>
        ))}
        {errors.experience && (
          <Text style={styles.errorText}>{errors.experience}</Text>
        )}
      </View>

      <View style={styles.inputContainer}>
        <Text style={styles.inputLabel}>Descripci√≥n Profesional</Text>
        <TextInput
          style={[styles.textArea, errors.description && styles.inputError]}
          placeholder="Describe tu experiencia, especialidades y lo que te hace √∫nico como profesional..."
          value={professionalFormData.description}
          onChangeText={(value) =>
            updateProfessionalFormData("description", value)
          }
          multiline
          numberOfLines={4}
        />
        {errors.description && (
          <Text style={styles.errorText}>{errors.description}</Text>
        )}
      </View>

      <Input
        label="Ubicaci√≥n de Trabajo"
        placeholder="Ej: San Jos√©, Costa Rica"
        value={professionalFormData.location}
        onChangeText={(value) => updateProfessionalFormData("location", value)}
        error={errors.location}
      />

      <Input
        label="Horarios de Disponibilidad"
        placeholder="Ej: Lun-Vie 8:00 AM - 6:00 PM"
        value={professionalFormData.availability}
        onChangeText={(value) =>
          updateProfessionalFormData("availability", value)
        }
      />

      <Input
        label="Tiempo de Respuesta"
        placeholder="Ej: 2-4 horas"
        value={professionalFormData.responseTime}
        onChangeText={(value) =>
          updateProfessionalFormData("responseTime", value)
        }
      />
    </View>
  );

  const renderProfessionalStep3 = () => (
    <View style={styles.stepContainer}>
      <View style={styles.stepHeader}>
        <Ionicons name="cash" size={40} color={theme.colors.primary} />
        <Text style={styles.stepTitle}>Servicios y Precios</Text>
        <Text style={styles.stepSubtitle}>
          Define qu√© ofreces y a qu√© precio
        </Text>
      </View>

      <View style={styles.inputContainer}>
        <Text style={styles.inputLabel}>Servicios que Ofreces</Text>
        <View style={styles.addItemContainer}>
          <TextInput
            style={styles.addItemInput}
            placeholder="Ej: Reparaci√≥n de tuber√≠as"
            value={serviceText}
            onChangeText={setServiceText}
            onSubmitEditing={handleAddService}
          />
          <TouchableOpacity style={styles.addButton} onPress={handleAddService}>
            <Ionicons name="add" size={20} color={theme.colors.white} />
          </TouchableOpacity>
        </View>

        <View style={styles.itemsList}>
          {professionalFormData.services.map((service, index) => (
            <View key={index} style={styles.itemCard}>
              <Text style={styles.itemText}>{service}</Text>
              <TouchableOpacity onPress={() => handleRemoveService(index)}>
                <Ionicons
                  name="close-circle"
                  size={20}
                  color={theme.colors.error}
                />
              </TouchableOpacity>
            </View>
          ))}
        </View>
        {errors.services && (
          <Text style={styles.errorText}>{errors.services}</Text>
        )}
      </View>

      <Input
        label="Rango de Precios"
        placeholder="Ej: $50 - $150 por trabajo"
        value={professionalFormData.priceRange}
        onChangeText={(value) =>
          updateProfessionalFormData("priceRange", value)
        }
        error={errors.priceRange}
      />
    </View>
  );

  const renderProfessionalStep4 = () => (
    <View style={styles.stepContainer}>
      <View style={styles.stepHeader}>
        <Ionicons name="school" size={40} color={theme.colors.primary} />
        <Text style={styles.stepTitle}>Certificaciones e Idiomas</Text>
        <Text style={styles.stepSubtitle}>
          Completa tu perfil profesional con tus certificaciones
        </Text>
      </View>

      <View style={styles.inputContainer}>
        <Text style={styles.inputLabel}>Certificaciones</Text>
        <View style={styles.addItemContainer}>
          <TextInput
            style={styles.addItemInput}
            placeholder="Ej: T√©cnico en Plomer√≠a"
            value={certificationText}
            onChangeText={setCertificationText}
            onSubmitEditing={handleAddCertification}
          />
          <TouchableOpacity
            style={styles.addButton}
            onPress={handleAddCertification}
          >
            <Ionicons name="add" size={20} color={theme.colors.white} />
          </TouchableOpacity>
        </View>

        <View style={styles.itemsList}>
          {professionalFormData.certifications.map((certification, index) => (
            <View key={index} style={styles.certificationCard}>
              <View style={styles.certificationHeader}>
                <Text style={styles.certificationName}>{certification}</Text>
                <TouchableOpacity
                  onPress={() => handleRemoveCertification(index)}
                >
                  <Ionicons
                    name="close-circle"
                    size={20}
                    color={theme.colors.error}
                  />
                </TouchableOpacity>
              </View>

              {/* Documento de la certificaci√≥n */}
              <View style={styles.documentUploadContainer}>
                <Text style={styles.uploadLabel}>
                  Documento de la certificaci√≥n:
                </Text>
                {professionalFormData.certificationDocuments[index] ? (
                  <View style={styles.documentPreviewContainer}>
                    {professionalFormData.certificationDocuments[
                      index
                    ]?.includes(".pdf") ||
                    professionalFormData.certificationDocuments[
                      index
                    ]?.includes(".doc") ||
                    professionalFormData.certificationDocuments[
                      index
                    ]?.includes(".txt") ||
                    professionalFormData.certificationDocuments[
                      index
                    ]?.includes(".xls") ? (
                      // Mostrar documento
                      <View style={styles.documentPreview}>
                        <Ionicons
                          name="document"
                          size={40}
                          color={theme.colors.primary}
                        />
                        <Text style={styles.documentName}>
                          {professionalFormData.certificationDocuments[index]
                            ?.split("/")
                            .pop() || "Documento"}
                        </Text>
                        <Text style={styles.documentType}>
                          Documento cargado ‚úì
                        </Text>
                      </View>
                    ) : (
                      // Mostrar imagen
                      <Image
                        source={{
                          uri: professionalFormData.certificationDocuments[
                            index
                          ],
                        }}
                        style={styles.imagePreview}
                      />
                    )}
                    <TouchableOpacity
                      style={styles.removeImageButton}
                      onPress={() => handleRemoveCertificationDocument(index)}
                    >
                      <Ionicons
                        name="close-circle"
                        size={24}
                        color={theme.colors.error}
                      />
                    </TouchableOpacity>
                  </View>
                ) : (
                  <View style={styles.certificationUploadButtonsContainer}>
                    <TouchableOpacity
                      style={styles.certificationUploadButton}
                      onPress={() => selectCertificationDocument(index)}
                    >
                      <Ionicons
                        name="images"
                        size={24}
                        color={theme.colors.white}
                      />
                    </TouchableOpacity>
                    <TouchableOpacity
                      style={styles.certificationUploadButton}
                      onPress={() => selectCertificationPDF(index)}
                    >
                      <Ionicons
                        name="document"
                        size={24}
                        color={theme.colors.white}
                      />
                    </TouchableOpacity>
                  </View>
                )}
              </View>
            </View>
          ))}
        </View>
      </View>

      <View style={styles.inputContainer}>
        <Text style={styles.inputLabel}>Idiomas que Hablas</Text>
        <View style={styles.addItemContainer}>
          <TextInput
            style={styles.addItemInput}
            placeholder="Ej: Espa√±ol"
            value={languageText}
            onChangeText={setLanguageText}
            onSubmitEditing={handleAddLanguage}
          />
          <TouchableOpacity
            style={styles.addButton}
            onPress={handleAddLanguage}
          >
            <Ionicons name="add" size={20} color={theme.colors.white} />
          </TouchableOpacity>
        </View>

        <View style={styles.itemsList}>
          {professionalFormData.languages.map((language, index) => (
            <View key={index} style={styles.itemCard}>
              <Text style={styles.itemText}>{language}</Text>
              <TouchableOpacity onPress={() => handleRemoveLanguage(index)}>
                <Ionicons
                  name="close-circle"
                  size={20}
                  color={theme.colors.error}
                />
              </TouchableOpacity>
            </View>
          ))}
        </View>
      </View>
    </View>
  );

    <View style={styles.container}>
      <KeyboardAvoidingView
        behavior={Platform.OS === "ios" ? "padding" : "height"}
        style={styles.keyboardView}
      >
        <ScrollView
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
        >
          {/* Header simplificado */}
          <View style={styles.verificationHeader}>
            <TouchableOpacity
              style={styles.verificationBackButton}
              onPress={() => {
                setShowVerificationModal(false);
                setRoleSelected(false);
                setSelectedRole(null);
                setVerificationComplete(false);
                setVerificationStep(1);
                setVerificationData({
                  dniFront: null,
                  dniBack: null,
                  profilePhoto: null,
                });
              }}
            >
              <Ionicons
                name="arrow-back"
                size={24}
                color={theme.colors.primary}
              />
            </TouchableOpacity>
          </View>

          {/* Progress Bar */}
          <View style={styles.progressContainer}>
            <View style={styles.progressBar}>
              <View
                style={[
                  styles.progressFill,
                  { width: `${(verificationStep / 3) * 100}%` },
                ]}
              />
            </View>
          </View>

          {/* Form Steps */}
          <View style={styles.verificationFormContainer}>
            {verificationStep === 1 && (
              <View style={styles.stepContainer}>
                <View style={styles.stepHeader}>
                  <Ionicons
                    name="card"
                    size={60}
                    color={theme.colors.primary}
                  />
                  <Text style={styles.stepTitle}>DNI - Frente</Text>
                  <Text style={styles.stepSubtitle}>
                    Toma una foto del frente de tu DNI para verificar tu
                    identidad
                  </Text>
                  <Text style={styles.stepInstructions}>
                    üìã IMPORTANTE: Debe ser un ESCANEO del DNI completo, no una
                    foto casual.
                    {"\n"}‚Ä¢ Aseg√∫rate de que todo el texto sea legible
                    {"\n"}‚Ä¢ Evita sombras, reflejos o cortes
                    {"\n"}‚Ä¢ Usa buena iluminaci√≥n
                    {"\n"}‚Ä¢ La validaci√≥n se realiza INMEDIATAMENTE al subir la
                    imagen
                  </Text>
                </View>

                <View style={styles.documentUploadContainer}>
                  {verificationData.dniFront ? (
                    <View style={styles.imagePreviewContainer}>
                      <Image
                        source={{ uri: verificationData.dniFront }}
                        style={styles.imagePreview}
                      />

                      {/* Estado de verificaci√≥n */}
                      <View style={styles.verificationStatusContainer}>
                        {verificationStatus.dniFront === "verifying" && (
                          <View style={styles.verifyingStatus}>
                            <ActivityIndicator
                              size="small"
                              color={theme.colors.primary}
                            />
                            <Text style={styles.verifyingText}>
                              Verificando...
                            </Text>
                          </View>
                        )}
                        {verificationStatus.dniFront === "verified" && (
                          <View style={styles.verifiedStatus}>
                            <Ionicons
                              name="checkmark-circle"
                              size={20}
                              color={theme.colors.success}
                            />
                            <Text style={styles.verifiedText}>
                              Verificado ‚úì
                            </Text>
                          </View>
                        )}
                      </View>

                      <TouchableOpacity
                        style={styles.removeImageButton}
                        onPress={() => {
                          setVerificationData((prev) => ({
                            ...prev,
                            dniFront: null,
                          }));
                          setVerificationStatus((prev) => ({
                            ...prev,
                            dniFront: "pending",
                          }));
                        }}
                      >
                        <Ionicons
                          name="close-circle"
                          size={24}
                          color={theme.colors.error}
                        />
                      </TouchableOpacity>
                    </View>
                  ) : (
                    <View style={styles.uploadButtonsContainer}>
                      <TouchableOpacity
                        style={styles.uploadButton}
                        onPress={() => takeVerificationPhoto("dniFront")}
                      >
                        <Ionicons
                          name="camera"
                          size={20}
                          color={theme.colors.white}
                        />
                        <Text style={styles.uploadButtonText}>C√°mara</Text>
                      </TouchableOpacity>
                      <TouchableOpacity
                        style={styles.uploadButton}
                        onPress={() => selectVerificationImage("dniFront")}
                      >
                        <Ionicons
                          name="images"
                          size={20}
                          color={theme.colors.white}
                        />
                        <Text style={styles.uploadButtonText}>Galer√≠a</Text>
                      </TouchableOpacity>
                    </View>
                  )}
                </View>
              </View>
            )}

  // Renderizar formulario de profesional
  const renderProfessionalForm = () => (
    <View style={styles.container}>
      <KeyboardAvoidingView
        behavior={Platform.OS === "ios" ? "padding" : "height"}
        style={styles.keyboardView}
      >
        <ScrollView
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
        >
          {/* Header con gradiente */}
          <LinearGradient
            colors={[theme.colors.primary, theme.colors.secondary]}
            style={styles.headerGradient}
          >
            <View style={styles.headerContent}>
              <TouchableOpacity
                style={styles.backButton}
                onPress={handleBackToRoleSelection}
              >
                <Ionicons name="arrow-back" size={24} color={theme.colors.white} />
              </TouchableOpacity>
              <View style={styles.headerTextContainer}>
                <Text style={styles.headerTitle}>
                  Registro Profesional
                </Text>
                <Text style={styles.headerSubtitle}>
                  Paso {currentStep} de 4
                </Text>
              </View>
            </View>
          </LinearGradient>

          {/* Progress Bar */}
          <View style={styles.progressContainer}>
            <View style={styles.progressBar}>
              <View
                style={[
                  styles.progressFill,
                  { width: `${(currentStep / 4) * 100}%` },
                ]}
              />
            </View>
          </View>

          {/* Step Content */}
          {currentStep === 1 && (
            <View style={styles.stepContainer}>
              <View style={styles.stepHeader}>
                <Ionicons
                  name="person"
                  size={60}
                  color={theme.colors.primary}
                  style={styles.stepIcon}
                />
                <Text style={styles.stepTitle}>Datos B√°sicos</Text>
                <Text style={styles.stepSubtitle}>
                  Comencemos con tus datos b√°sicos
                </Text>
              </View>
              <View style={styles.stepContainer}>
                <View style={styles.stepHeader}>
                  <Ionicons
                    name="card"
                    size={60}
                    color={theme.colors.primary}
                  />
                  <Text style={styles.stepTitle}>DNI - Dorso</Text>
                  <Text style={styles.stepSubtitle}>
                    Toma una foto del dorso de tu DNI para completar la
                    verificaci√≥n
                  </Text>
                  <Text style={styles.stepInstructions}>
                    üìã IMPORTANTE: Debe ser un ESCANEO del DNI completo, no una
                    foto casual.
                    {"\n"}‚Ä¢ Aseg√∫rate de que todo el texto sea legible
                    {"\n"}‚Ä¢ Evita sombras, reflejos o cortes
                    {"\n"}‚Ä¢ Usa buena iluminaci√≥n
                    {"\n"}‚Ä¢ La validaci√≥n se realiza INMEDIATAMENTE al subir la
                    imagen
                  </Text>
                </View>

                <View style={styles.documentUploadContainer}>
                  {verificationData.dniBack ? (
                    <View style={styles.imagePreviewContainer}>
                      <Image
                        source={{ uri: verificationData.dniBack }}
                        style={styles.imagePreview}
                      />

                      {/* Estado de verificaci√≥n */}
                      <View style={styles.verificationStatusContainer}>
                        {verificationStatus.dniBack === "verifying" && (
                          <View style={styles.verifyingStatus}>
                            <ActivityIndicator
                              size="small"
                              color={theme.colors.primary}
                            />
                            <Text style={styles.verifyingText}>
                              Verificando...
                            </Text>
                          </View>
                        )}
                        {verificationStatus.dniBack === "verified" && (
                          <View style={styles.verifiedStatus}>
                            <Ionicons
                              name="checkmark-circle"
                              size={20}
                              color={theme.colors.success}
                            />
                            <Text style={styles.verifiedText}>
                              Verificado ‚úì
                            </Text>
                          </View>
                        )}
                      </View>

                      <TouchableOpacity
                        style={styles.removeImageButton}
                        onPress={() => {
                          setVerificationData((prev) => ({
                            ...prev,
                            dniBack: null,
                          }));
                          setVerificationStatus((prev) => ({
                            ...prev,
                            dniBack: "pending",
                          }));
                        }}
                      >
                        <Ionicons
                          name="close-circle"
                          size={24}
                          color={theme.colors.error}
                        />
                      </TouchableOpacity>
                    </View>
                  ) : (
                    <View style={styles.uploadButtonsContainer}>
                      <TouchableOpacity
                        style={styles.uploadButton}
                        onPress={() => takeVerificationPhoto("dniBack")}
                      >
                        <Ionicons
                          name="camera"
                          size={20}
                          color={theme.colors.white}
                        />
                        <Text style={styles.uploadButtonText}>C√°mara</Text>
                      </TouchableOpacity>
                      <TouchableOpacity
                        style={styles.uploadButton}
                        onPress={() => selectVerificationImage("dniBack")}
                      >
                        <Ionicons
                          name="images"
                          size={20}
                          color={theme.colors.white}
                        />
                        <Text style={styles.uploadButtonText}>Galer√≠a</Text>
                      </TouchableOpacity>
                    </View>
                  )}
                </View>
              </View>
            )}

            {verificationStep === 3 && (
              <View style={styles.stepContainer}>
                <View style={styles.stepHeader}>
                  <Ionicons
                    name="person"
                    size={60}
                    color={theme.colors.primary}
                  />
                  <Text style={styles.stepTitle}>Foto de Perfil</Text>
                  <Text style={styles.stepSubtitle}>
                    Toma una foto de tu rostro para completar tu perfil
                    profesional
                  </Text>
                  <Text style={styles.stepInstructions}>
                    üì∏ IMPORTANTE: Debe ser una SELFIE clara de tu rostro, no
                    una foto de objeto o grupo.
                    {"\n"}‚Ä¢ Enfoca tu rostro claramente
                    {"\n"}‚Ä¢ Usa buena iluminaci√≥n natural
                    {"\n"}‚Ä¢ Evita sombras o reflejos
                    {"\n"}‚Ä¢ No uses filtros o efectos
                    {"\n"}‚Ä¢ La validaci√≥n se realiza INMEDIATAMENTE al subir la
                    imagen
                  </Text>
                </View>

                <View style={styles.documentUploadContainer}>
                  {verificationData.profilePhoto ? (
                    <View style={styles.imagePreviewContainer}>
                      <Image
                        source={{ uri: verificationData.profilePhoto }}
                        style={styles.imagePreview}
                      />

                      {/* Estado de verificaci√≥n */}
                      <View style={styles.verificationStatusContainer}>
                        {verificationStatus.profilePhoto === "verifying" && (
                          <View style={styles.verifyingStatus}>
                            <ActivityIndicator
                              size="small"
                              color={theme.colors.primary}
                            />
                            <Text style={styles.verifyingText}>
                              Verificando...
                            </Text>
                          </View>
                        )}
                        {verificationStatus.profilePhoto === "verified" && (
                          <View style={styles.verifiedStatus}>
                            <Ionicons
                              name="checkmark-circle"
                              size={20}
                              color={theme.colors.success}
                            />
                            <Text style={styles.verifiedText}>
                              Verificado ‚úì
                            </Text>
                          </View>
                        )}
                      </View>

                      <TouchableOpacity
                        style={styles.removeImageButton}
                        onPress={() => {
                          setVerificationData((prev) => ({
                            ...prev,
                            profilePhoto: null,
                          }));
                          setVerificationStatus((prev) => ({
                            ...prev,
                            profilePhoto: "pending",
                          }));
                        }}
                      >
                        <Ionicons
                          name="close-circle"
                          size={24}
                          color={theme.colors.error}
                        />
                      </TouchableOpacity>
                    </View>
                  ) : (
                    <View style={styles.uploadButtonsContainer}>
                      <TouchableOpacity
                        style={styles.uploadButton}
                        onPress={() => takeVerificationPhoto("profilePhoto")}
                      >
                        <Ionicons
                          name="camera"
                          size={20}
                          color={theme.colors.white}
                        />
                        <Text style={styles.uploadButtonText}>C√°mara</Text>
                      </TouchableOpacity>
                      <TouchableOpacity
                        style={styles.uploadButton}
                        onPress={() => selectVerificationImage("profilePhoto")}
                      >
                        <Ionicons
                          name="images"
                          size={20}
                          color={theme.colors.white}
                        />
                        <Text style={styles.uploadButtonText}>Galer√≠a</Text>
                      </TouchableOpacity>
                    </View>
                  )}
                </View>
              </View>
            )}
          </View>

          {/* Botones de navegaci√≥n */}
          <View style={styles.footer}>
            {currentStep > 1 && (
              <TouchableOpacity
                style={styles.backButtonFooter}
                onPress={() => setCurrentStep(currentStep - 1)}
              >
                <Text style={styles.backButtonText}>Atr√°s</Text>
              </TouchableOpacity>
            )}
            {currentStep > 1 && <View style={styles.buttonSpacer} />}
            <TouchableOpacity
              style={[
                styles.nextButton,
                currentStep === 1 && styles.nextButtonFull,
              ]}
              onPress={currentStep === 4 ? handleProfessionalSubmit : handleProfessionalNext}
              disabled={professionalLoading}
            >
              {professionalLoading ? (
                <ActivityIndicator size="small" color={theme.colors.white} />
              ) : (
                <>
                  <Text style={styles.nextButtonText}>
                    {currentStep === 4
                      ? "Completar Registro"
                      : "Siguiente"}
                  </Text>
                  <Ionicons
                    name="arrow-forward"
                    size={20}
                    color={theme.colors.white}
                  />
                </>
              )}
            </TouchableOpacity>
          </View>
        </ScrollView>
      </KeyboardAvoidingView>
    </View>
  );

  // Renderizar seg√∫n el estado
  if (!roleSelected) {
    return renderRoleSelection();
  } else if (selectedRole === "client") {
    return renderClientForm();
  } else {
    // Para profesionales, mostrar formulario directamente
    return renderProfessionalForm();
  }
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },
  keyboardView: {
    flex: 1,
  },
  scrollContent: {
    paddingBottom: theme.spacing.xl,
  },
  header: {
    paddingTop: theme.spacing.xl,
    paddingBottom: theme.spacing.lg,
    paddingHorizontal: theme.spacing.lg,
  },
  backButton: {
    position: "absolute",
    top: theme.spacing.xl,
    left: theme.spacing.lg,
    zIndex: 1,
    padding: theme.spacing.sm,
    borderRadius: theme.borderRadius.md,
    backgroundColor: "rgba(255, 255, 255, 0.2)",
  },
  headerTextContainer: {
    alignItems: "center",
    marginTop: theme.spacing.lg,
  },
  headerTitle: {
    fontSize: 28,
    fontWeight: "bold",
    color: theme.colors.white,
    marginBottom: theme.spacing.sm,
  },
  headerSubtitle: {
    fontSize: 16,
    color: theme.colors.white,
    opacity: 0.9,
  },
  progressContainer: {
    paddingHorizontal: theme.spacing.lg,
    marginBottom: theme.spacing.lg,
  },
  progressBar: {
    height: 4,
    backgroundColor: theme.colors.lightGray,
    borderRadius: 2,
    overflow: "hidden",
  },
  progressFill: {
    height: "100%",
    backgroundColor: theme.colors.secondary,
    borderRadius: 2,
  },
  stepContainer: {
    paddingHorizontal: theme.spacing.lg,
  },
  stepHeader: {
    alignItems: "center",
    marginBottom: theme.spacing.xl,
  },
  stepIcon: {
    marginBottom: theme.spacing.md,
  },
  stepTitle: {
    fontSize: 24,
    fontWeight: "bold",
    color: theme.colors.text,
    marginBottom: theme.spacing.sm,
    textAlign: "center",
  },
  stepSubtitle: {
    fontSize: 16,
    color: theme.colors.gray,
    textAlign: "center",
  },
  inputContainer: {
    marginBottom: theme.spacing.lg,
  },
  inputLabel: {
    fontSize: 16,
    fontWeight: "600",
    color: theme.colors.text,
    marginBottom: theme.spacing.sm,
  },
  footer: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    paddingHorizontal: theme.spacing.lg,
    paddingVertical: theme.spacing.lg,
    backgroundColor: theme.colors.white,
    borderTopWidth: 1,
    borderTopColor: theme.colors.lightGray,
  },
  backButtonFooter: {
    flex: 1,
    paddingVertical: theme.spacing.md,
    paddingHorizontal: theme.spacing.lg,
    borderRadius: theme.borderRadius.md,
    backgroundColor: theme.colors.lightGray,
    alignItems: "center",
    marginRight: theme.spacing.sm,
  },
  backButtonText: {
    fontSize: 16,
    fontWeight: "600",
    color: theme.colors.text,
  },
  buttonSpacer: {
    width: theme.spacing.sm,
  },
  nextButton: {
    flex: 1,
    flexDirection: "row",
    justifyContent: "center",
    alignItems: "center",
    paddingVertical: theme.spacing.md,
    paddingHorizontal: theme.spacing.lg,
    borderRadius: theme.borderRadius.md,
    backgroundColor: theme.colors.primary,
  },
  nextButtonFull: {
    flex: 1,
  },
  nextButtonText: {
    fontSize: 16,
    fontWeight: "600",
    color: theme.colors.white,
    marginRight: theme.spacing.sm,
  },
  errorText: {
    fontSize: 14,
    color: theme.colors.error,
    marginTop: theme.spacing.sm,
  },
});

export default RegisterScreen;
